<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }</style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">

    <!-- ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
    <header class="bg-indigo-900 text-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-user-shield text-2xl"></i>
                <span class="text-xl font-bold cursor-pointer" onclick="goDashboard()">Admin Dashboard</span>
                <span class="bg-indigo-700 text-xs px-2 py-1 rounded text-indigo-200 hidden sm:inline">Google Sheets DB</span>
            </div>
            <a href="index.html" class="px-4 py-2 bg-indigo-800 hover:bg-indigo-700 rounded-lg text-sm font-medium transition-colors">
                <i class="fa-solid fa-eye"></i> ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå
            </a>
        </div>
    </header>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
    <main id="admin-content" class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="py-20 text-center text-gray-500" id="loading-state">
            <i class="fa-solid fa-spinner fa-spin text-3xl mb-4 text-indigo-600"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>
    </main>

    <!-- ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3">
        <i class="fa-solid fa-circle-check text-green-400"></i>
        <span id="toast-msg">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
    </div>

    <script>
        // üî• ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà üî•
        const GOOGLE_SHEET_API_URL = "https://script.google.com/macros/s/AKfycbzA1ZXHWBEXuwp4Gmu8SEc9q8WKUYi33NA8t1AixdE8PF2rXfklGQ6H6Z6vxCW--39J/exec"; 

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let novels = [];
        let chapters = [];
        
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        let state = { 
            view: 'dashboard', // 'dashboard' ‡∏´‡∏£‡∏∑‡∏≠ 'manage_chapters'
            editingNovelId: null,
            activeNovelId: null, 
            editingChapterId: null,
            chapterCurrentPage: 1, 
            chapterItemsPerPage: 50 
        };

        // --- 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
        async function loadData() {
            try {
                const res = await fetch(GOOGLE_SHEET_API_URL);
                const data = await res.json();
                
                novels = data.novels.map(n => ({
                    ...n, 
                    views: parseInt(n.views) || 0,
                    categories: n.categories ? n.categories.toString().split(',').map(s => s.trim()) : []
                }));
                chapters = data.chapters || [];
                
                render();
            } catch (err) {
                console.error(err);
                document.getElementById('loading-state').innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500 text-3xl mb-4"></i><br>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }
        
        loadData();

        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.innerHTML = isError 
                ? `<i class="fa-solid fa-circle-xmark text-red-400"></i><span id="toast-msg">${msg}</span>`
                : `<i class="fa-solid fa-circle-check text-green-400"></i><span id="toast-msg">${msg}</span>`;
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            if (window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Excel
        async function syncToGoogleSheets(payload) {
            try {
                showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
                const res = await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(result.status === 'success') showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                else showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + result.message, true);
            } catch (e) {
                showToast("‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï", true);
            }
        }

        // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Router) ---
        function render(scrollToTop = true) {
            const container = document.getElementById('admin-content');
            if (state.view === 'dashboard') {
                container.innerHTML = renderDashboard();
            } else if (state.view === 'manage_chapters') {
                container.innerHTML = renderManageChapters();
            }
            if(scrollToTop) window.scrollTo(0, 0);
        }

        // ==========================================
        // UI: ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏ß‡∏°‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢)
        // ==========================================
        function renderDashboard() {
            const editMode = state.editingNovelId !== null;
            const editingNovel = editMode ? novels.find(n => n.id === state.editingNovelId) : null;

            let novelFormHtml = '';
            if (editMode && editingNovel) {
                novelFormHtml = `
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 border-b pb-3 text-yellow-600"><i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h2>
                    <form onsubmit="handleUpdateNovel(event)" class="space-y-5">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="text" id="edit_n_title" value="${editingNovel.title}" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤</label><input type="text" id="edit_n_author" value="${editingNovel.author}" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500"></div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                            <select id="edit_n_status" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white outline-none focus:ring-2 focus:ring-yellow-500">
                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà" ${editingNovel.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
                                <option value="‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß" ${editingNovel.status === '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß' ? 'selected' : ''}>‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</option>
                                <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß" ${editingNovel.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å</label><input type="url" id="edit_n_cover" value="${editingNovel.cover}" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥)</label><input type="text" id="edit_n_cat" value="${editingNovel.categories ? editingNovel.categories.join(', ') : ''}" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠</label><textarea id="edit_n_synopsis" rows="4" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500">${editingNovel.synopsis}</textarea></div>
                        <div class="flex gap-3 pt-2">
                            <button type="submit" class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600 transition-colors shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button type="button" onclick="cancelEditNovel()" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </form>
                `;
            } else {
                novelFormHtml = `
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 border-b pb-3"><i class="fa-solid fa-book-medical text-indigo-600"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
                    <form onsubmit="handleAddNovel(event)" class="space-y-5">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="text" id="add_n_title" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ô‡∏≤‡∏°‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤</label><input type="text" id="add_n_author" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                            <select id="add_n_status" class="w-full border border-gray-300 rounded-lg p-2.5 bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
                                <option value="‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß">‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</option>
                                <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å</label><input type="url" id="add_n_cover" placeholder="https://..." required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥)</label><input type="text" id="add_n_cat" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ, ‡∏£‡∏∞‡∏ö‡∏ö" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠</label><textarea id="add_n_synopsis" rows="4" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-indigo-500"></textarea></div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </form>
                `;
            }

            const statusColor = {
                '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà': 'text-green-600',
                '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß': 'text-orange-500',
                '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß': 'text-blue-600'
            };

            let novelTableHtml = novels.length === 0 
                ? `<tr><td colspan="5" class="p-8 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>` 
                : novels.map((n, idx) => `
                <tr class="border-b border-gray-100 hover:bg-indigo-50 transition-colors">
                    <td class="p-4 text-center text-gray-500">${idx + 1}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-4">
                            <img src="${n.cover}" class="w-12 h-16 object-cover rounded shadow-sm shrink-0" onerror="this.src='https://via.placeholder.com/150'">
                            <div>
                                <div class="font-bold text-gray-800 line-clamp-1 text-base">${n.title}</div>
                                <div class="text-sm font-medium ${statusColor[n.status] || 'text-gray-500'} mt-1">${n.status}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-center text-gray-600 hidden sm:table-cell">${(n.views || 0).toLocaleString()}</td>
                    <td class="p-4 text-center">
                        <button onclick="manageNovelChapters('${n.id}')" class="text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-4 py-2 rounded-md font-medium transition-colors shadow-sm w-full sm:w-auto mb-2 sm:mb-0 sm:mr-2">
                            <i class="fa-solid fa-list-ul mr-1"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô
                        </button>
                        <button onclick="startEditNovel('${n.id}')" class="text-yellow-600 bg-yellow-50 hover:bg-yellow-100 p-2 rounded transition-colors mr-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteNovel('${n.id}')" class="text-red-600 bg-red-50 hover:bg-red-100 p-2 rounded transition-colors" title="‡∏•‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="flex flex-col gap-8 mb-8">
                    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏¢‡∏≤‡∏ß -->
                    <div class="w-full">
                        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-200" id="novel-form-section">
                            ${novelFormHtml}
                        </div>
                    </div>
                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ -->
                    <div class="w-full">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-layer-group text-indigo-600 mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ (${novels.length} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)</h2>
                                <button onclick="loadData()" class="text-sm bg-white border border-gray-300 px-4 py-2 rounded-lg text-gray-600 hover:text-indigo-600 font-medium shadow-sm"><i class="fa-solid fa-rotate-right mr-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse min-w-[600px]">
                                    <thead>
                                        <tr class="bg-white border-b border-gray-200 text-gray-500 text-sm">
                                            <th class="p-4 font-medium text-center w-16">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                                            <th class="p-4 font-medium">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                            <th class="p-4 font-medium text-center hidden sm:table-cell w-28">‡∏ß‡∏¥‡∏ß</th>
                                            <th class="p-4 font-medium text-center w-64">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                    <tbody>${novelTableHtml}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // UI: ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) 
        // ==========================================
        function renderManageChapters() {
            const novel = novels.find(n => n.id === state.activeNovelId);
            if (!novel) { goDashboard(); return ''; }

            const novelChapters = chapters.filter(c => c.novelId === novel.id).sort((a, b) => a.chapterNumber - b.chapterNumber);
            
            const nextChNum = novelChapters.length > 0 ? Math.max(...novelChapters.map(c => c.chapterNumber)) + 1 : 1;

            const editMode = state.editingChapterId !== null;
            const editingChapter = editMode ? chapters.find(c => c.id === state.editingChapterId) : null;
            const editContent = editingChapter ? editingChapter.content.replace(/<br>/g, '\n') : '';

            // Pagination Logic 
            const totalItems = novelChapters.length;
            const totalPages = Math.ceil(totalItems / state.chapterItemsPerPage);
            if (state.chapterCurrentPage > totalPages && totalPages > 0) state.chapterCurrentPage = totalPages;
            else if (state.chapterCurrentPage < 1) state.chapterCurrentPage = 1;

            const startIndex = (state.chapterCurrentPage - 1) * state.chapterItemsPerPage;
            const endIndex = startIndex + state.chapterItemsPerPage;
            const paginatedChapters = novelChapters.slice(startIndex, endIndex);

            // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå TXT ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
            const uploadBoxHtml = `
                <div class="mb-6 p-5 bg-indigo-50 border border-indigo-100 rounded-xl flex flex-col gap-3 shadow-sm">
                    <div>
                        <div class="text-base font-bold text-indigo-800"><i class="fa-solid fa-file-lines mr-1"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .txt</div>
                        <div class="text-sm text-indigo-600 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏ï‡∏≠‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                    </div>
                    <input type="file" accept=".txt" onchange="handleTxtUpload(event)" class="text-sm file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-bold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer w-full sm:w-auto">
                </div>
            `;

            let chapterFormHtml = '';
            if (editMode && editingChapter) {
                chapterFormHtml = `
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 border-b pb-3 text-yellow-600"><i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${editingChapter.chapterNumber}</h2>
                    ${uploadBoxHtml}
                    <form onsubmit="handleUpdateChapter(event)" class="space-y-5">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
                            <div class="sm:col-span-1"><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà</label><input type="number" id="edit_ch_num" value="${editingChapter.chapterNumber}" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500"></div>
                            <div class="sm:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô</label><input type="text" id="edit_ch_title" value="${editingChapter.title}" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-yellow-500"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex justify-between items-center">
                                <span>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</span>
                                <button type="button" onclick="autoFormatContent('edit_ch_content')" class="text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 transition-colors flex items-center gap-2 shadow-sm font-medium">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏à‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                            </label>
                            <textarea id="edit_ch_content" rows="15" required class="w-full border border-gray-300 rounded-lg p-4 outline-none focus:ring-2 focus:ring-yellow-500 font-serif leading-relaxed text-base">${editContent}</textarea>
                        </div>
                        <div class="flex gap-4 pt-2">
                            <button type="submit" class="flex-1 bg-yellow-500 text-white font-bold py-3 rounded-lg hover:bg-yellow-600 transition-colors shadow-md text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
                            <button type="button" onclick="cancelEditChapter()" class="w-32 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-300 transition-colors text-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </form>
                `;
            } else {
                chapterFormHtml = `
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 border-b pb-3"><i class="fa-solid fa-file-circle-plus text-green-600"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                    ${uploadBoxHtml}
                    <form onsubmit="handleAddChapter(event)" class="space-y-5">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
                            <div class="sm:col-span-1"><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà</label><input type="number" id="add_ch_num" value="${nextChNum}" min="1" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-green-500"></div>
                            <div class="sm:col-span-2"><label class="block text-sm font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô</label><input type="text" id="add_ch_title" required class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-green-500"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 flex justify-between items-center">
                                <span>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</span>
                                <button type="button" onclick="autoFormatContent('add_ch_content')" class="text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 transition-colors flex items-center gap-2 shadow-sm font-medium">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> ‡∏à‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                            </label>
                            <textarea id="add_ch_content" rows="15" required class="w-full border border-gray-300 rounded-lg p-4 outline-none focus:ring-2 focus:ring-green-500 font-serif leading-relaxed text-base" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .txt ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢..."></textarea>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-lg hover:bg-green-700 transition-colors shadow-md text-lg">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                    </form>
                `;
            }

            let chapterTableHtml = paginatedChapters.length === 0 
                ? `<tr><td colspan="3" class="p-8 text-center text-gray-500 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>` 
                : paginatedChapters.map(ch => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <td class="p-4 text-center font-bold text-gray-600 w-24 text-base">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${ch.chapterNumber}</td>
                    <td class="p-4 font-medium text-gray-800 text-base">${ch.title}</td>
                    <td class="p-4 text-center w-32">
                        <button onclick="startEditChapter('${ch.id}')" class="text-yellow-600 bg-yellow-50 hover:bg-yellow-100 p-2.5 rounded transition-colors mr-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteChapter('${ch.id}')" class="text-red-600 bg-red-50 hover:bg-red-100 p-2.5 rounded transition-colors" title="‡∏•‡∏ö"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Pagination UI
            let paginationHtml = '';
            if (totalPages > 1) {
                let pageButtons = '';
                let startPage = Math.max(1, state.chapterCurrentPage - 2);
                let endPage = Math.min(totalPages, state.chapterCurrentPage + 2);

                if (state.chapterCurrentPage > 1) {
                    pageButtons += `<button onclick="changeChapterPage(${state.chapterCurrentPage - 1})" class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm font-medium"><i class="fa-solid fa-chevron-left mr-1"></i> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>`;
                }

                for (let i = startPage; i <= endPage; i++) {
                    if (i === state.chapterCurrentPage) {
                        pageButtons += `<button class="px-4 py-2 bg-indigo-600 text-white border border-indigo-600 rounded text-sm font-bold shadow-sm">${i}</button>`;
                    } else {
                        pageButtons += `<button onclick="changeChapterPage(${i})" class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm font-medium">${i}</button>`;
                    }
                }

                if (state.chapterCurrentPage < totalPages) {
                    pageButtons += `<button onclick="changeChapterPage(${state.chapterCurrentPage + 1})" class="px-4 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-sm font-medium">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <i class="fa-solid fa-chevron-right ml-1"></i></button>`;
                }

                paginationHtml = `
                    <div class="flex flex-col sm:flex-row items-center justify-between p-5 border-t border-gray-200 bg-gray-50 gap-4">
                        <div class="text-base text-gray-600 font-medium">‡πÅ‡∏™‡∏î‡∏á <span class="text-gray-900">${startIndex + 1}</span> ‡∏ñ‡∏∂‡∏á <span class="text-gray-900">${Math.min(endIndex, totalItems)}</span> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏ï‡∏≠‡∏ô</div>
                        <div class="flex gap-2 shadow-sm rounded">${pageButtons}</div>
                    </div>
                `;
            } else if (totalItems > 0) {
                 paginationHtml = `
                    <div class="flex items-center justify-between p-5 border-t border-gray-200 bg-gray-50">
                        <div class="text-base text-gray-600 font-medium">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏ï‡∏≠‡∏ô</div>
                    </div>
                `;
            }

            return `
                <button onclick="goDashboard()" class="flex items-center gap-2 text-gray-600 hover:text-indigo-600 font-bold mb-6 transition-colors bg-white px-5 py-2.5 rounded-full shadow-sm w-fit border border-gray-200">
                    <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢
                </button>

                <!-- ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 mb-8 flex items-center gap-6 md:gap-8">
                    <img src="${novel.cover}" class="w-24 h-32 md:w-32 md:h-44 object-cover rounded-xl shadow-md" onerror="this.src='https://via.placeholder.com/150'">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">${novel.title}</h1>
                        <p class="text-gray-600 text-lg"><i class="fa-solid fa-pen-nib mr-2"></i>‡∏ú‡∏π‡πâ‡πÅ‡∏ï‡πà‡∏á: ${novel.author} | ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span class="font-bold text-indigo-600">${totalItems}</span> ‡∏ï‡∏≠‡∏ô</p>
                    </div>
                </div>

                <div class="flex flex-col gap-8 mb-8">
                    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ô ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏¢‡∏≤‡∏ß -->
                    <div class="w-full">
                        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-200" id="chapter-form-section">
                            ${chapterFormHtml}
                        </div>
                    </div>
                    
                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≠‡∏ô ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏¢‡∏≤‡∏ß -->
                    <div class="w-full">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
                            <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center" id="chapter-list-section">
                                <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-list-ul text-green-600 mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô (‡∏´‡∏ô‡πâ‡∏≤ ${state.chapterCurrentPage})</h2>
                            </div>
                            <div class="overflow-x-auto overflow-y-auto" style="max-h: 800px;">
                                <table class="w-full text-left border-collapse">
                                    <thead class="sticky top-0 bg-white shadow-sm z-10">
                                        <tr class="border-b border-gray-200 text-gray-500 text-sm">
                                            <th class="p-4 font-medium text-center w-24">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≠‡∏ô</th>
                                            <th class="p-4 font-medium">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô</th>
                                            <th class="p-4 font-medium text-center w-32">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                        </tr>
                                    </thead>
                                    <tbody>${chapterTableHtml}</tbody>
                                </table>
                            </div>
                            ${paginationHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
        // ==========================================
        window.handleTxtUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                let text = e.target.result.trim();
                
                let chNum = '';
                let title = '';
                let content = text;

                let lines = text.split('\n');
                let firstLine = lines[0].trim();
                
                // ‡πÉ‡∏ä‡πâ Regex ‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ö‡∏ó‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà" ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                let matchPrefix = firstLine.match(/^(?:‡∏ö‡∏ó‡∏ó‡∏µ‡πà|‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà)\s*(\d+)?\s*(.*)/);
                
                if (matchPrefix) {
                    if (matchPrefix[1]) chNum = matchPrefix[1];
                    
                    let remainingFirstLine = matchPrefix[2].trim();
                    
                    if (lines.length === 1) {
                        let spaceIndex = remainingFirstLine.indexOf(' ');
                        if (spaceIndex !== -1) {
                            title = remainingFirstLine.substring(0, spaceIndex).trim(); 
                            content = remainingFirstLine.substring(spaceIndex).trim();  
                        } else {
                            title = remainingFirstLine;
                            content = '';
                        }
                    } else {
                        title = remainingFirstLine;
                        content = lines.slice(1).join('\n').trim();
                    }
                }

                const numInput = document.getElementById('add_ch_num') || document.getElementById('edit_ch_num');
                const titleInput = document.getElementById('add_ch_title') || document.getElementById('edit_ch_title');
                const contentInput = document.getElementById('add_ch_content') || document.getElementById('edit_ch_content');

                if (numInput && chNum) numInput.value = chNum;
                if (titleInput && title) titleInput.value = title;
                if (contentInput) {
                    contentInput.value = content;
                    autoFormatContent(contentInput.id, false);
                }
                
                showToast("‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                event.target.value = ''; 
            };
            reader.readAsText(file, 'UTF-8'); 
        }

        window.autoFormatContent = function(textAreaId, notify = true) {
            const textarea = document.getElementById(textAreaId);
            if (!textarea) return;
            
            let text = textarea.value;

            text = text.replace(/ {2,}/g, ' ');
            text = text.replace(/(["‚Äú].*?["‚Äù])/g, '\n$1\n');
            text = text.replace(/\n{3,}/g, '\n\n');
            text = text.split('\n').map(line => line.trim()).join('\n');

            textarea.value = text.trim();
            if(notify) showToast("‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        }

        // ==========================================
        // 4. Actions - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ (Novel)
        // ==========================================
        window.goDashboard = function() {
            state.view = 'dashboard';
            state.activeNovelId = null;
            state.editingNovelId = null;
            state.editingChapterId = null;
            render();
        }

        window.manageNovelChapters = function(id) {
            state.view = 'manage_chapters';
            state.activeNovelId = id;
            state.editingChapterId = null;
            state.chapterCurrentPage = 1; 
            render();
        }

        window.changeChapterPage = function(pageNumber) {
            state.chapterCurrentPage = pageNumber;
            render(false);
            const chapterSection = document.getElementById('chapter-list-section');
            if (chapterSection) {
                const yOffset = -80; 
                const y = chapterSection.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
            }
        }

        window.handleAddNovel = function(e) {
            e.preventDefault();
            const newId = 'n' + Date.now();
            const newNovel = {
                id: newId,
                title: document.getElementById('add_n_title').value,
                author: document.getElementById('add_n_author').value,
                cover: document.getElementById('add_n_cover').value,
                categories: document.getElementById('add_n_cat').value.split(',').map(s => s.trim()),
                synopsis: document.getElementById('add_n_synopsis').value,
                status: document.getElementById('add_n_status').value, 
                views: 0
            };
            novels.unshift(newNovel);
            e.target.reset(); render();
            syncToGoogleSheets({ action: 'addNovel', novel: newNovel });
        }

        window.startEditNovel = function(id) {
            state.editingNovelId = id; render();
            document.getElementById('novel-form-section').scrollIntoView({ behavior: 'smooth' });
        }

        window.cancelEditNovel = function() { state.editingNovelId = null; render(); }

        window.handleUpdateNovel = function(e) {
            e.preventDefault();
            const target = novels.find(n => n.id === state.editingNovelId);
            if(!target) return;
            target.title = document.getElementById('edit_n_title').value;
            target.author = document.getElementById('edit_n_author').value;
            target.cover = document.getElementById('edit_n_cover').value;
            target.categories = document.getElementById('edit_n_cat').value.split(',').map(s => s.trim());
            target.status = document.getElementById('edit_n_status').value;
            target.synopsis = document.getElementById('edit_n_synopsis').value;
            
            const payload = {...target};
            state.editingNovelId = null; render();
            syncToGoogleSheets({ action: 'updateNovel', id: target.id, novel: payload });
        }

        window.deleteNovel = function(id) {
            if (confirm('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?\n(‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢)')) {
                novels = novels.filter(n => n.id !== id);
                chapters = chapters.filter(c => c.novelId !== id);
                render();
                syncToGoogleSheets({ action: 'deleteNovel', id: id });
            }
        }

        // ==========================================
        // 5. Actions - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô (Chapter)
        // ==========================================
        window.handleAddChapter = function(e) {
            e.preventDefault();
            const formattedContent = document.getElementById('add_ch_content').value.replace(/\n/g, '<br>');
            const newChapter = {
                id: 'c' + Date.now(),
                novelId: state.activeNovelId, 
                chapterNumber: parseInt(document.getElementById('add_ch_num').value),
                title: document.getElementById('add_ch_title').value,
                content: formattedContent
            };
            chapters.push(newChapter);
            state.editingChapterId = null;
            
            const novelChapters = chapters.filter(c => c.novelId === state.activeNovelId);
            const totalPages = Math.ceil(novelChapters.length / state.chapterItemsPerPage);
            state.chapterCurrentPage = totalPages; 
            
            e.target.reset();
            render(false);
            syncToGoogleSheets({ action: 'addChapter', chapter: newChapter });
        }

        window.startEditChapter = function(id) {
            state.editingChapterId = id; render(false);
            document.getElementById('chapter-form-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.cancelEditChapter = function() { state.editingChapterId = null; render(false); }

        window.handleUpdateChapter = function(e) {
            e.preventDefault();
            const target = chapters.find(c => c.id === state.editingChapterId);
            if(!target) return;
            
            target.chapterNumber = parseInt(document.getElementById('edit_ch_num').value);
            target.title = document.getElementById('edit_ch_title').value;
            target.content = document.getElementById('edit_ch_content').value.replace(/\n/g, '<br>');
            
            const payload = {...target};
            state.editingChapterId = null; render(false);
            syncToGoogleSheets({ action: 'updateChapter', id: target.id, chapter: payload });
        }

        window.deleteChapter = function(id) {
            if (confirm('‡∏•‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö? (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)')) {
                chapters = chapters.filter(c => c.id !== id);
                render(false);
                syncToGoogleSheets({ action: 'deleteChapter', id: id });
            }
        }
    </script>
</body>
</html>
